# cuttlefish-setup service: runs init.cuttlefish.sh script
type init_wifi_sh, domain;
type init_wifi_sh_exec, vendor_file_type, exec_type, file_type;

init_daemon_domain(init_wifi_sh)

allow init_wifi_sh self:capability { fowner chown net_admin net_raw };
allow init_wifi_sh self:udp_socket { create ioctl };
allow init_wifi_sh vendor_toolbox_exec:file execute_no_trans;
allow init_wifi_sh vendor_file:file execute_no_trans;
allowxperm init_wifi_sh self:udp_socket ioctl priv_sock_ioctls;
wakelock_use(init_wifi_sh);
allow init_wifi_sh vendor_shell_exec:file { rx_file_perms };
#============= init_wifi_sh ==============
allow init_wifi_sh cuttlefish_ip_exec:file execute_no_trans;
allow init_wifi_sh cuttlefish_iw_exec:file execute_no_trans;

# Set system properties to start services
set_prop(init_wifi_sh, ctl_default_prop);

# Set up WiFi
allow init_wifi_sh self:netlink_route_socket { create nlmsg_write setopt bind getattr read write nlmsg_read };
allow init_wifi_sh self:netlink_generic_socket create_socket_perms_no_ioctl;
allow init_wifi_sh self:capability { sys_module sys_admin };
allow init_wifi_sh varrun_file:dir { mounton open read write add_name search remove_name };
allow init_wifi_sh varrun_file:file { mounton getattr create read write open unlink };
allow init_wifi_sh execns_exec:file rx_file_perms;
allow init_wifi_sh proc_net:file rw_file_perms;
allow init_wifi_sh proc:file r_file_perms;
allow init_wifi_sh nsfs:file r_file_perms;
allow init_wifi_sh system_data_file:dir getattr;
# Allow init_wifi_sh to run init.wifi.sh
allow init_wifi_sh init_wifi_sh_exec:file execute_no_trans;
# iw
allow init_wifi_sh sysfs:file { read open };
# iptables
allow init_wifi_sh self:rawip_socket { create getopt setopt };
# Allow init_wifi_sh to read createns proc file to get the namespace file
allow init_wifi_sh createns:file { read };
allow init_wifi_sh createns:dir { search };
allow init_wifi_sh createns:lnk_file { read };
# Allow init_wifi_sh to copy the hostapd conf template to the vendor data dir
allow init_wifi_sh hostapd_data_file:file create_file_perms;
allow init_wifi_sh hostapd_data_file:dir rw_dir_perms;
#allow init_wifi_sh system_file:file { execute getattr open read };
dontaudit init_wifi_sh self:capability dac_override;
